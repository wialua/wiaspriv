-- ULTIMATE Pumpkin Farm Script v5 - INSTANT CFrame TP, ERROR-FREE, SYNAPSE X OPTIMIZED
-- Pure CFrame Instant TP @ 60FPS | No Deprecated Props | Live Dropdowns | All Fixed
-- Watermark: Live Counts | Themes/Saves | Ultra-Stable
local vu = game:GetService("VirtualUser")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

-- Anti-idle
LocalPlayer.Idled:Connect(function()
    vu:Button2Down(Vector2.new(0,0), Workspace.CurrentCamera.CFrame)
    task.wait(1)
    vu:Button2Up(Vector2.new(0,0), Workspace.CurrentCamera.CFrame)
end)

-- Load LinoriaLib
local repo = 'https://raw.githubusercontent.com/violin-suzutsuki/LinoriaLib/main/'
local Library = loadstring(game:HttpGet(repo .. 'Library.lua'))()
local ThemeManager = loadstring(game:HttpGet(repo .. 'addons/ThemeManager.lua'))()
local SaveManager = loadstring(game:HttpGet(repo .. 'addons/SaveManager.lua'))()

local Window = Library:CreateWindow({
    Title = 'Berke mad cityin abisi - Ultimate v5',
    Center = true,
    AutoShow = true,
    TabPadding = 8,
    MenuFadeTime = 0.2
})

local Tabs = {
    Main = Window:AddTab('Tokens & MyCrops (P1-P2)'),
    Fields = Window:AddTab('Fields (P3)'),
    Auto = Window:AddTab('Auto Sell & Harvest'),
    Upgrades = Window:AddTab('Upgrades'),
    ['UI Settings'] = Window:AddTab('UI Settings'),
}

-- ==================== CORE VARS & CACHING ====================
local tokenPartsByName = {}
local cropPartsByName = {}
local fieldPartsByName = {}
local selectedToken = nil
local selectedCrop = nil
local selectedField = nil
local tokenHeight = 4
local cropHeight = 4
local fieldHeight = 7
local autoSellDelay = 1
local upgradeDelay = 0.5
local farmConn = nil
local autoCollectConn = nil
local autoCollectHeartbeat = nil
local connections = {}

-- ==================== UTILS ====================
local function addPart(partsByName, part)
    local name = part.Name
    if not partsByName[name] then partsByName[name] = {} end
    table.insert(partsByName[name], part)
end

local function removePart(partsByName, part)
    local name = part.Name
    local list = partsByName[name]
    if list then
        for i = #list, 1, -1 do
            if list[i] == part then
                table.remove(list, i)
                break
            end
        end
        if #list == 0 then partsByName[name] = nil end
    end
end

local function getDropdownValues(partsByName)
    local vals = {}
    for name, list in pairs(partsByName) do
        local cnt = #list
        if cnt > 0 then
            table.insert(vals, name .. " (" .. cnt .. ")")
        end
    end
    table.sort(vals, function(a, b)
        return a:match("^(.-) %("):lower() < b:match("^(.-) %("):lower()
    end)
    return vals
end

local function parseName(fullVal)
    return fullVal:match("^(.-) %(.*%)") or fullVal:match("^(.-)$")
end

local function getFullName(name, partsByName)
    local list = partsByName[name]
    if list and #list > 0 then
        return name .. " (" .. #list .. ")"
    end
    return nil
end

local function findClosest(list, pos)
    local closest, minDist = nil, math.huge
    for _, part in ipairs(list) do
        if part and part.Parent then
            local dist = (pos - part.Position).Magnitude
            if dist < minDist then
                minDist = dist
                closest = part
            end
        end
    end
    return closest
end

local function anyTpActive()
    return (Toggles.TokenTp and Toggles.TokenTp.Value) or
           (Toggles.CropTp and Toggles.CropTp.Value) or
           (Toggles.FieldTp and Toggles.FieldTp.Value)
end

local function getRootPart()
    local char = LocalPlayer.Character
    if char then
        return char:FindFirstChild("HumanoidRootPart")
    end
    return nil
end

local function startFarm()
    if farmConn then return end
    farmConn = RunService.Heartbeat:Connect(function()
        local hrp = getRootPart()
        if not hrp then return end
        local pos = hrp.Position
        local tpDone = false
        
        -- P1: Tokens
        if Toggles.TokenTp.Value and selectedToken and tokenPartsByName[selectedToken] then
            local list = tokenPartsByName[selectedToken]
            local closest = findClosest(list, pos)
            if closest then
                hrp.AssemblyLinearVelocity = Vector3.zero
                hrp.AssemblyAngularVelocity = Vector3.zero
                local tpPos = closest.Position + Vector3.new(0, tokenHeight, 0)
                hrp.CFrame = CFrame.new(tpPos) * CFrame.Angles(0, math.rad(math.random(0, 360)), 0)
                firetouchinterest(hrp, closest, 0)
                task.wait(0.01)
                firetouchinterest(hrp, closest, 1)
                tpDone = true
            end
        end
        
        -- P2: MyCrops
        if not tpDone and Toggles.CropTp.Value and selectedCrop and cropPartsByName[selectedCrop] then
            local list = cropPartsByName[selectedCrop]
            local closest = findClosest(list, pos)
            if closest then
                hrp.AssemblyLinearVelocity = Vector3.zero
                hrp.AssemblyAngularVelocity = Vector3.zero
                local tpPos = closest.Position + Vector3.new(0, cropHeight, 0)
                hrp.CFrame = CFrame.new(tpPos) * CFrame.Angles(0, math.rad(math.random(0, 360)), 0)
                firetouchinterest(hrp, closest, 0)
                task.wait(0.01)
                firetouchinterest(hrp, closest, 1)
                tpDone = true
            end
        end
        
        -- P3: Fields
        if not tpDone and Toggles.FieldTp.Value and selectedField and fieldPartsByName[selectedField] then
            local list = fieldPartsByName[selectedField]
            local closest = findClosest(list, pos)
            if closest then
                hrp.AssemblyLinearVelocity = Vector3.zero
                hrp.AssemblyAngularVelocity = Vector3.zero
                local tpPos = closest.Position + Vector3.new(0, fieldHeight, 0)
                hrp.CFrame = CFrame.new(tpPos) * CFrame.Angles(0, math.rad(math.random(0, 360)), 0)
                firetouchinterest(hrp, closest, 0)
                task.wait(0.01)
                firetouchinterest(hrp, closest, 1)
            end
        end
    end)
end

local function stopFarm()
    if farmConn then
        farmConn:Disconnect()
        farmConn = nil
    end
end

local function addConnection(conn)
    table.insert(connections, conn)
end

-- ==================== FOLDERS (INFINITE WAIT) ====================
local tokensFolder = Workspace:WaitForChild("Tokens", math.huge)
local cropsFolder = Workspace:WaitForChild("MyCrops", math.huge)
local fieldsFolder = Workspace:FindFirstChild("Fields")

-- Initial populate
for _, desc in ipairs(tokensFolder:GetDescendants()) do
    if desc:IsA("BasePart") then addPart(tokenPartsByName, desc) end
end
for _, desc in ipairs(cropsFolder:GetDescendants()) do
    if desc:IsA("BasePart") then addPart(cropPartsByName, desc) end
end
if fieldsFolder then
    for _, desc in ipairs(fieldsFolder:GetDescendants()) do
        if desc:IsA("BasePart") then addPart(fieldPartsByName, desc) end
    end
end

-- Connections
addConnection(tokensFolder.DescendantAdded:Connect(function(desc)
    if desc:IsA("BasePart") then addPart(tokenPartsByName, desc) end
end))
addConnection(tokensFolder.DescendantRemoving:Connect(function(desc)
    if desc:IsA("BasePart") then removePart(tokenPartsByName, desc) end
end))
addConnection(cropsFolder.DescendantAdded:Connect(function(desc)
    if desc:IsA("BasePart") then addPart(cropPartsByName, desc) end
end))
addConnection(cropsFolder.DescendantRemoving:Connect(function(desc)
    if desc:IsA("BasePart") then removePart(cropPartsByName, desc) end
end))
if fieldsFolder then
    addConnection(fieldsFolder.DescendantAdded:Connect(function(desc)
        if desc:IsA("BasePart") then addPart(fieldPartsByName, desc) end
    end))
    addConnection(fieldsFolder.DescendantRemoving:Connect(function(desc)
        if desc:IsA("BasePart") then removePart(fieldPartsByName, desc) end
    end))
end

-- Character reload handling
addConnection(LocalPlayer.CharacterAdded:Connect(function(newChar)
    task.wait(0.5) -- Wait for HRP to load
    if anyTpActive() then
        stopFarm()
        startFarm()
    end
end))

-- ==================== UI: TOKENS ====================
local MainLeft = Tabs.Main:AddLeftGroupbox('Tokens (Priority 1)')
MainLeft:AddDropdown('TokenDropdown', {
    Values = getDropdownValues(tokenPartsByName),
    Default = 1,
    Text = 'Tokens (Live)',
    Tooltip = 'Name (Count) - Auto updates instantly',
    Callback = function(v)
        selectedToken = parseName(v)
    end
})

MainLeft:AddSlider('TokenHeightSlider', {
    Text = 'TP Height',
    Default = 4,
    Min = 0,
    Max = 20,
    Rounding = 0,
    Callback = function(v) tokenHeight = v end
})

MainLeft:AddToggle('TokenTp', {
    Text = 'INSTANT TP Tokens (60 FPS)',
    Default = false,
    Tooltip = 'Instant TP to closest token',
    Callback = function(v)
        if v and not selectedToken then
            Library:Notify('Select token first!', 4)
            Toggles.TokenTp:SetValue(false)
            return
        end
        if v then
            startFarm()
        else
            if not anyTpActive() then
                stopFarm()
            end
        end
    end
})

-- ==================== UI: MyCrops ====================
local MainRight = Tabs.Main:AddRightGroupbox('MyCrops (Priority 2)')
MainRight:AddDropdown('CropDropdown', {
    Values = getDropdownValues(cropPartsByName),
    Default = 1,
    Text = 'MyCrops (Live)',
    Tooltip = 'Name (Count) - Auto updates instantly',
    Callback = function(v)
        selectedCrop = parseName(v)
    end
})

MainRight:AddSlider('CropHeightSlider', {
    Text = 'TP Height',
    Default = 4,
    Min = 0,
    Max = 20,
    Rounding = 0,
    Callback = function(v) cropHeight = v end
})

MainRight:AddToggle('CropTp', {
    Text = 'INSTANT TP Crops (60 FPS)',
    Default = false,
    Tooltip = 'Instant TP to closest crop',
    Callback = function(v)
        if v and not selectedCrop then
            Library:Notify('Select crop first!', 4)
            Toggles.CropTp:SetValue(false)
            return
        end
        if v then
            startFarm()
        else
            if not anyTpActive() then
                stopFarm()
            end
        end
    end
})

-- ==================== UI: Fields ====================
local FieldsGroup = Tabs.Fields:AddLeftGroupbox('Fields (Priority 3)')
FieldsGroup:AddDropdown('FieldDropdown', {
    Values = getDropdownValues(fieldPartsByName),
    Default = 1,
    Text = 'Fields (Live)',
    Tooltip = 'Name (Count) - Auto if folder exists',
    Callback = function(v)
        selectedField = parseName(v)
    end
})

FieldsGroup:AddSlider('FieldHeightSlider', {
    Text = 'TP Height',
    Default = 7,
    Min = 0,
    Max = 25,
    Rounding = 0,
    Callback = function(v) fieldHeight = v end
})

FieldsGroup:AddToggle('FieldTp', {
    Text = 'INSTANT TP Fields (60 FPS)',
    Default = false,
    Tooltip = 'Instant TP to closest field',
    Callback = function(v)
        if v and not selectedField then
            Library:Notify('Select field first!', 4)
            Toggles.FieldTp:SetValue(false)
            return
        end
        if v then
            startFarm()
        else
            if not anyTpActive() then
                stopFarm()
            end
        end
    end
})

-- ==================== UI: AUTO ====================
local AutoLeft = Tabs.Auto:AddLeftGroupbox('Auto Sell')
AutoLeft:AddSlider('AutoSellDelaySlider', {
    Text = 'Delay (s)',
    Default = 1,
    Min = 0.1,
    Max = 10,
    Rounding = 1,
    Callback = function(v) autoSellDelay = v end
})

AutoLeft:AddToggle('AutoSell', {
    Text = 'Sell All',
    Default = false,
    Tooltip = 'Infinite sell loop',
    Callback = function(v)
        if v then
            task.spawn(function()
                local event = ReplicatedStorage.Remotes:WaitForChild("Purchase2", 10)
                if not event then
                    Library:Notify('Purchase2 not found!', 5)
                    Toggles.AutoSell:SetValue(false)
                    return
                end
                while Toggles.AutoSell.Value and not Library.Unloaded do
                    pcall(function() event:FireServer("fgtiuyw4eror4tuyfd%HHHHHHHhddset678%iftes7%7w4ftr76st76fs") end)
                    task.wait(autoSellDelay)
                end
            end)
        end
    end
})

local AutoRight = Tabs.Auto:AddRightGroupbox('Harvest')
AutoRight:AddToggle('HarvestSpam', {
    Text = 'Spam Swing (60 FPS)',
    Default = false,
    Tooltip = 'Max harvest speed',
    Callback = function(v)
        local event = ReplicatedStorage:FindFirstChild("HarvestSwing")
        if not event then
            Library:Notify('HarvestSwing not found!', 5)
            Toggles.HarvestSpam:SetValue(false)
            return
        end
        if v then
            local spamConn = RunService.Stepped:Connect(function()
                if not Toggles.HarvestSpam.Value or Library.Unloaded then return end
                pcall(function() event:FireServer() end)
            end)
            addConnection(spamConn)
        end
    end
})

-- ==================== AUTO COLLECT V2 ====================
local function startAutoCollect()
    if autoCollectConn then return end
    local hrp = getRootPart()
    if not hrp then return end
    
    -- Fire existing
    for _, desc in ipairs(tokensFolder:GetDescendants()) do
        if desc:IsA("BasePart") and desc:FindFirstChild("TouchInterest") then
            firetouchinterest(hrp, desc, 0)
            task.wait(0.01)
            firetouchinterest(hrp, desc, 1)
        end
    end
    
    autoCollectConn = tokensFolder.DescendantAdded:Connect(function(desc)
        local hrp = getRootPart()
        if not hrp or not Toggles.AutoCollectV2Test.Value then return end
        if desc:IsA("BasePart") then
            local touch = desc:WaitForChild("TouchInterest", 1)
            if touch then
                firetouchinterest(hrp, desc, 0)
                task.wait(0.01)
                firetouchinterest(hrp, desc, 1)
            end
        end
    end)
    
    autoCollectHeartbeat = RunService.Heartbeat:Connect(function()
        if not Toggles.AutoCollectV2Test.Value or Library.Unloaded then return end
        local hrp = getRootPart()
        if not hrp then return end
        for _, desc in ipairs(tokensFolder:GetDescendants()) do
            if desc:IsA("BasePart") and desc:FindFirstChild("TouchInterest") then
                firetouchinterest(hrp, desc, 0)
            end
        end
    end)
end

local function stopAutoCollect()
    if autoCollectConn then
        autoCollectConn:Disconnect()
        autoCollectConn = nil
    end
    if autoCollectHeartbeat then
        autoCollectHeartbeat:Disconnect()
        autoCollectHeartbeat = nil
    end
end

MainLeft:AddToggle('AutoCollectV2Test', {
    Text = 'Auto Collect v2 (Ultra Fast)',
    Default = false,
    Tooltip = 'Instant collect all tokens + loop',
    Callback = function(v)
        if v then
            startAutoCollect()
        else
            stopAutoCollect()
        end
    end
})

-- ==================== UI: UPGRADES ====================
local UpgradesGroup = Tabs.Upgrades:AddLeftGroupbox('Pumpkin Upgrades')
UpgradesGroup:AddSlider('UpgradeDelaySlider', {
    Text = 'Delay (s)',
    Default = 0.5,
    Min = 0.1,
    Max = 5,
    Rounding = 1,
    Callback = function(v) upgradeDelay = v end
})

UpgradesGroup:AddToggle('PassiveSkulls', {
    Text = 'Passive Skulls',
    Default = false,
    Callback = function(v)
        if v then
            task.spawn(function()
                local event = ReplicatedStorage.Remotes:WaitForChild("Upgrade", 10)
                if not event then
                    Library:Notify('Upgrade not found!', 5)
                    Toggles.PassiveSkulls:SetValue(false)
                    return
                end
                while Toggles.PassiveSkulls.Value and not Library.Unloaded do
                    pcall(function() event:FireServer("PassiveSkulls", "Pumpkin") end)
                    task.wait(upgradeDelay)
                end
            end)
        end
    end
})

UpgradesGroup:AddToggle('PumpkinUpgrade', {
    Text = 'Pumpkin Upgrade',
    Default = false,
    Callback = function(v)
        if v then
            task.spawn(function()
                local event = ReplicatedStorage.Remotes:WaitForChild("Upgrade", 10)
                if not event then
                    Library:Notify('Upgrade not found!', 5)
                    Toggles.PumpkinUpgrade:SetValue(false)
                    return
                end
                while Toggles.PumpkinUpgrade.Value and not Library.Unloaded do
                    pcall(function() event:FireServer("PumkinUpgrade", "Pumpkin") end)
                    task.wait(upgradeDelay)
                end
            end)
        end
    end
})

UpgradesGroup:AddToggle('PumpkinUpgrade2', {
    Text = 'Skull Upgrade',
    Default = false,
    Callback = function(v)
        if v then
            task.spawn(function()
                local event = ReplicatedStorage.Remotes:WaitForChild("Upgrade", 10)
                if not event then
                    Library:Notify('Upgrade not found!', 5)
                    Toggles.PumpkinUpgrade2:SetValue(false)
                    return
                end
                while Toggles.PumpkinUpgrade2.Value and not Library.Unloaded do
                    pcall(function() event:FireServer("PumkinUpgrade2", "Skull") end)
                    task.wait(upgradeDelay)
                end
            end)
        end
    end
})

UpgradesGroup:AddToggle('CandyCornUpgrade', {
    Text = 'Candy Corn Upgrade',
    Default = false,
    Callback = function(v)
        if v then
            task.spawn(function()
                local event = ReplicatedStorage.Remotes:WaitForChild("Upgrade", 10)
                if not event then
                    Library:Notify('Upgrade not found!', 5)
                    Toggles.CandyCornUpgrade:SetValue(false)
                    return
                end
                while Toggles.CandyCornUpgrade.Value and not Library.Unloaded do
                    pcall(function() event:FireServer("CandyCornUpgrade1", "Skull") end)
                    task.wait(upgradeDelay)
                end
            end)
        end
    end
})

UpgradesGroup:AddToggle('CandyCornUpgrade2', {
    Text = 'Candy Corn Upgrade 2',
    Default = false,
    Callback = function(v)
        if v then
            task.spawn(function()
                local event = ReplicatedStorage.Remotes:WaitForChild("Upgrade", 10)
                if not event then
                    Library:Notify('Upgrade not found!', 5)
                    Toggles.CandyCornUpgrade2:SetValue(false)
                    return
                end
                while Toggles.CandyCornUpgrade2.Value and not Library.Unloaded do
                    pcall(function() event:FireServer("CandyCornUpgrade2", "Pumpkin") end)
                    task.wait(upgradeDelay)
                end
            end)
        end
    end
})

UpgradesGroup:AddToggle('CropsUpgrade1', {
    Text = 'Crops Upgrade 1',
    Default = false,
    Callback = function(v)
        if v then
            task.spawn(function()
                local event = ReplicatedStorage.Remotes:WaitForChild("Upgrade", 10)
                if not event then
                    Library:Notify('Upgrade not found!', 5)
                    Toggles.CropsUpgrade1:SetValue(false)
                    return
                end
                while Toggles.CropsUpgrade1.Value and not Library.Unloaded do
                    pcall(function() event:FireServer("MuscleMultiUpgrade1", "Cash") end)
                    task.wait(upgradeDelay)
                end
            end)
        end
    end
})

UpgradesGroup:AddButton({
    Text = 'All Once',
    Func = function()
        local event = ReplicatedStorage.Remotes:FindFirstChild("Upgrade")
        if event then
            pcall(function() event:FireServer("PassiveSkulls", "Pumpkin") end)
            pcall(function() event:FireServer("PumkinUpgrade", "Pumpkin") end)
            pcall(function() event:FireServer("PumkinUpgrade2", "Skull") end)
            pcall(function() event:FireServer("CandyCornUpgrade1", "Skull") end)
            pcall(function() event:FireServer("CandyCornUpgrade2", "Pumpkin") end)
            pcall(function() event:FireServer("MuscleMultiUpgrade1", "Cash") end)
            Library:Notify('All upgrades fired once!', 3)
        else
            Library:Notify('Upgrade remote not found!', 5)
        end
    end
})

-- ==================== LIVE DROPDOWN REFRESH ====================
task.spawn(function()
    local lastKey = ''
    while not Library.Unloaded do
        task.wait(0.3)
        local vals = getDropdownValues(tokenPartsByName)
        local key = table.concat(vals, '|')
        if key ~= lastKey then
            lastKey = key
            Options.TokenDropdown:SetValues(vals)
            local full = getFullName(selectedToken, tokenPartsByName)
            if full and table.find(vals, full) then
                Options.TokenDropdown:SetValue(full)
            elseif #vals > 0 then
                selectedToken = parseName(vals[1])
                Options.TokenDropdown:SetValue(vals[1])
                Library:Notify('Auto selected token: ' .. selectedToken, 3)
            else
                selectedToken = nil
            end
        end
    end
end)

task.spawn(function()
    local lastKey = ''
    while not Library.Unloaded do
        task.wait(0.3)
        local vals = getDropdownValues(cropPartsByName)
        local key = table.concat(vals, '|')
        if key ~= lastKey then
            lastKey = key
            Options.CropDropdown:SetValues(vals)
            local full = getFullName(selectedCrop, cropPartsByName)
            if full and table.find(vals, full) then
                Options.CropDropdown:SetValue(full)
            elseif #vals > 0 then
                selectedCrop = parseName(vals[1])
                Options.CropDropdown:SetValue(vals[1])
                Library:Notify('Auto selected crop: ' .. selectedCrop, 3)
            else
                selectedCrop = nil
            end
        end
    end
end)

task.spawn(function()
    local lastKey = ''
    while not Library.Unloaded do
        task.wait(0.3)
        local vals = getDropdownValues(fieldPartsByName)
        local key = table.concat(vals, '|')
        if key ~= lastKey then
            lastKey = key
            Options.FieldDropdown:SetValues(vals)
            local full = getFullName(selectedField, fieldPartsByName)
            if full and table.find(vals, full) then
                Options.FieldDropdown:SetValue(full)
            elseif #vals > 0 then
                selectedField = parseName(vals[1])
                Options.FieldDropdown:SetValue(vals[1])
                Library:Notify('Auto selected field: ' .. selectedField, 3)
            else
                selectedField = nil
            end
        end
    end
end)

-- ==================== WATERMARK ====================
Library:SetWatermarkVisibility(true)
local FrameTimer = tick()
local FrameCounter = 0
local FPS = 60
local WatermarkConn = RunService.RenderStepped:Connect(function()
    FrameCounter = FrameCounter + 1
    if tick() - FrameTimer >= 1 then
        FPS = FrameCounter
        FrameTimer = tick()
        FrameCounter = 0
    end
    local tcnt = selectedToken and (tokenPartsByName[selectedToken] and #tokenPartsByName[selectedToken] or 0) or 0
    local ccnt = selectedCrop and (cropPartsByName[selectedCrop] and #cropPartsByName[selectedCrop] or 0) or 0
    local fcnt = selectedField and (fieldPartsByName[selectedField] and #fieldPartsByName[selectedField] or 0) or 0
    local ping = math.floor(game:GetService('Stats').Network.ServerStatsItem['Data Ping']:GetValue())
    Library:SetWatermark(string.format('T:%d | C:%d | F:%d | FPS: %d | Ping: %d ms', tcnt, ccnt, fcnt, FPS, ping))
end)
addConnection(WatermarkConn)

-- ==================== UI SETTINGS ====================
local MenuGroup = Tabs['UI Settings']:AddLeftGroupbox('Controls')
MenuGroup:AddButton({Text = 'Unload', Func = function() Library:Unload() end})
MenuGroup:AddLabel('Menu Keybind'):AddKeyPicker('MenuKeybind', {Default = 'End', NoUI = true, Text = 'Menu keybind'})
Library.ToggleKeybind = Options.MenuKeybind

-- ==================== ADDONS ====================
ThemeManager:SetLibrary(Library)
SaveManager:SetLibrary(Library)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({'MenuKeybind'})
ThemeManager:SetFolder('PumpkinFarm')
SaveManager:SetFolder('PumpkinFarm')
SaveManager:BuildConfigSection(Tabs['UI Settings'])
ThemeManager:ApplyToTab(Tabs['UI Settings'])
SaveManager:LoadAutoloadConfig()

-- ==================== UNLOAD ====================
Library:OnUnload(function()
    stopFarm()
    stopAutoCollect()
    for _, conn in ipairs(connections) do
        if conn then conn:Disconnect() end
    end
    Library.Unloaded = true
    print('ULTIMATE v5 Unloaded!')
end)

Library.KeybindFrame.Visible = true
