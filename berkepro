local vu = game:GetService("VirtualUser")
local Players = game.Players
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

LocalPlayer.Idled:Connect(function()
    vu:Button2Down(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
    task.wait(1)
    vu:Button2Up(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
end)

local repo = 'https://raw.githubusercontent.com/violin-suzutsuki/LinoriaLib/main/'
local Library = loadstring(game:HttpGet(repo .. 'Library.lua'))()
local ThemeManager = loadstring(game:HttpGet(repo .. 'addons/ThemeManager.lua'))()
local SaveManager = loadstring(game:HttpGet(repo .. 'addons/SaveManager.lua'))()

local Window = Library:CreateWindow({
    Title = 'Berke mad cityin abisi',
    Center = true,
    AutoShow = true,
    TabPadding = 8,
    MenuFadeTime = 0.2
})

local Tabs = {
    Main = Window:AddTab('Tokens & MyCrops'),
    Fields = Window:AddTab('Fields'),
    Upgrades = Window:AddTab('Upgrades'),
    ['UI Settings'] = Window:AddTab('UI Settings'),
}

-- Variables
local selectedToken = nil
local selectedMyCrop = nil
local selectedField = nil
local tpHeight = 4
local autoSellDelay = 3
local upgradeDelay = 1
local farmConn = nil

-- Name counts for dropdowns (real-time unique names with presence count)
local tokenNameCounts = {}
local myCropNameCounts = {}
local fieldNameCounts = {}

-- Connections for real-time updates
local connTokenAdd, connTokenRem, connCropAdd, connCropRem, connFieldAdd, connFieldRem

-- Wait for folder safely
local function waitForFolder(folderName)
    local folder = workspace:FindFirstChild(folderName)
    while not folder do
        task.wait(0.1)
        folder = workspace:FindFirstChild(folderName)
    end
    return folder
end

-- Init counts
local function initCounts(folderName, countsTable)
    local folder = workspace:FindFirstChild(folderName)
    if folder then
        for _, desc in ipairs(folder:GetDescendants()) do
            if desc:IsA("BasePart") then
                local n = desc.Name
                countsTable[n] = (countsTable[n] or 0) + 1
            end
        end
    end
    return countsTable
end

tokenNameCounts = initCounts("Tokens", tokenNameCounts)
myCropNameCounts = initCounts("MyCrops", myCropNameCounts)
fieldNameCounts = initCounts("Fields", fieldNameCounts)

-- Setup real-time conns (safe if folder missing initially)
pcall(function()
    local tokensFolder = waitForFolder("Tokens")
    connTokenAdd = tokensFolder.DescendantAdded:Connect(function(desc)
        if desc:IsA("BasePart") then
            local n = desc.Name
            tokenNameCounts[n] = (tokenNameCounts[n] or 0) + 1
        end
    end)
    connTokenRem = tokensFolder.DescendantRemoving:Connect(function(desc)
        if desc:IsA("BasePart") then
            local n = desc.Name
            if tokenNameCounts[n] then
                tokenNameCounts[n] -= 1
                if tokenNameCounts[n] <= 0 then tokenNameCounts[n] = nil end
            end
        end
    end)
end)

pcall(function()
    local cropsFolder = waitForFolder("MyCrops")
    connCropAdd = cropsFolder.DescendantAdded:Connect(function(desc)
        if desc:IsA("BasePart") then
            local n = desc.Name
            myCropNameCounts[n] = (myCropNameCounts[n] or 0) + 1
        end
    end)
    connCropRem = cropsFolder.DescendantRemoving:Connect(function(desc)
        if desc:IsA("BasePart") then
            local n = desc.Name
            if myCropNameCounts[n] then
                myCropNameCounts[n] -= 1
                if myCropNameCounts[n] <= 0 then myCropNameCounts[n] = nil end
            end
        end
    end)
end)

pcall(function()
    local fieldsFolder = waitForFolder("Fields")
    connFieldAdd = fieldsFolder.DescendantAdded:Connect(function(desc)
        if desc:IsA("BasePart") then
            local n = desc.Name
            fieldNameCounts[n] = (fieldNameCounts[n] or 0) + 1
        end
    end)
    connFieldRem = fieldsFolder.DescendantRemoving:Connect(function(desc)
        if desc:IsA("BasePart") then
            local n = desc.Name
            if fieldNameCounts[n] then
                fieldNameCounts[n] -= 1
                if fieldNameCounts[n] <= 0 then fieldNameCounts[n] = nil end
            end
        end
    end)
end)

-- Get sorted values from counts
local function getSortedValues(countsTable)
    local vals = {}
    for name, _ in pairs(countsTable) do
        table.insert(vals, name)
    end
    table.sort(vals)
    return vals
end

-- Fast getTargets (GetDescendants, no recurse)
local function getTargets(folderName, targetName)
    if not targetName then return {} end
    local folder = workspace:FindFirstChild(folderName)
    if not folder then return {} end
    local targets = {}
    for _, desc in ipairs(folder:GetDescendants()) do
        if desc:IsA("BasePart") and desc.Name == targetName and desc.Parent then
            table.insert(targets, desc)
        end
    end
    return targets
end

-- Start/Stop central farm
local function startFarm()
    if farmConn then return end
    farmConn = RunService.Heartbeat:Connect(function()
        pcall(function()
            local char = LocalPlayer.Character
            if not char or not char.Parent then return end
            local hrp = char:FindFirstChild("HumanoidRootPart")
            if not hrp then return end

            local folderName, targetName, heightOffset = nil, nil, 0

            -- PRIORITY 1: Tokens
            if Toggles.TpTokensToggle.Value and selectedToken then
                local targets = getTargets("Tokens", selectedToken)
                if #targets > 0 then
                    folderName, targetName, heightOffset = "Tokens", selectedToken, 0
                end
            end

            -- PRIORITY 2: MyCrops (only if no tokens)
            if not folderName and Toggles.TpMyCropsToggle.Value and selectedMyCrop then
                local targets = getTargets("MyCrops", selectedMyCrop)
                if #targets > 0 then
                    folderName, targetName, heightOffset = "MyCrops", selectedMyCrop, 0
                end
            end

            -- PRIORITY 3: Fields (only if nothing higher)
            if not folderName and Toggles.TpFieldsToggle.Value and selectedField then
                local targets = getTargets("Fields", selectedField)
                if #targets > 0 then
                    folderName, targetName, heightOffset = "Fields", selectedField, 3
                end
            end

            if folderName then
                local folder = workspace:FindFirstChild(folderName)
                if not folder then return end

                local closest = nil
                local minDist = math.huge
                local pos = hrp.Position

                for _, desc in ipairs(folder:GetDescendants()) do
                    if desc:IsA("BasePart") and desc.Name == targetName and desc.Parent then
                        local dist = (pos - desc.Position).Magnitude
                        if dist < minDist then
                            minDist = dist
                            closest = desc
                        end
                    end
                end

                if closest then
                    -- Zero velocities for clean TP
                    hrp.AssemblyLinearVelocity = Vector3.zero
                    hrp.AssemblyAngularVelocity = Vector3.zero
                    hrp.Velocity = Vector3.zero
                    hrp.RotVelocity = Vector3.zero

                    -- TP with random full rotation
                    local tpPos = closest.Position + Vector3.new(0, tpHeight + heightOffset, 0)
                    hrp.CFrame = CFrame.new(tpPos) * CFrame.Angles(0, math.rad(math.random(0, 360)), 0)

                    -- NO EXTRA WAIT: If not collected, closest remains -> retry next frame automatically
                    -- Collects at ~60/s max (1/frame), stays if server delays removal
                end
            end
        end)
    end)
end

local function stopFarm()
    if farmConn then
        farmConn:Disconnect()
        farmConn = nil
    end
end

local function anyTpActive()
    return Toggles.TpTokensToggle.Value or Toggles.TpMyCropsToggle.Value or Toggles.TpFieldsToggle.Value
end

-- UI: Main Tab
local LeftMain = Tabs.Main:AddLeftGroupbox('Tokens Farm - PRIORITY 1 (ULTRA)')
local RightMain = Tabs.Main:AddRightGroupbox('MyCrops Farm - PRIORITY 2')

local TokenDrop = LeftMain:AddDropdown('TokenDropdown', {
    Values = getSortedValues(tokenNameCounts),
    Default = 1,
    Multi = false,
    Text = 'Select Token',
    Callback = function(v) selectedToken = v end
})
if #TokenDrop.Values > 0 then selectedToken = TokenDrop.Values[1] end

local MyCropDrop = RightMain:AddDropdown('MyCropDropdown', {
    Values = getSortedValues(myCropNameCounts),
    Default = 1,
    Multi = false,
    Text = 'Select MyCrop',
    Callback = function(v) selectedMyCrop = v end
})
if #MyCropDrop.Values > 0 then selectedMyCrop = MyCropDrop.Values[1] end

LeftMain:AddSlider('TpHeightSlider', {
    Text = 'TP Height (All)',
    Default = 4,
    Min = 1,
    Max = 10,
    Rounding = 0,
    Callback = function(v) tpHeight = v end
})

LeftMain:AddToggle('TpTokensToggle', {
    Text = 'Tokens TP - GOD SPEED',
    Default = false,
    Callback = function(v)
        if v then
            if not selectedToken then
                Library:Notify('Select a token first!')
                Toggles.TpTokensToggle:SetValue(false)
                return
            end
            startFarm()
        else
            if not anyTpActive() then stopFarm() end
        end
    end
})

RightMain:AddToggle('TpMyCropsToggle', {
    Text = 'MyCrops TP - GOD SPEED',
    Default = false,
    Callback = function(v)
        if v then
            if not selectedMyCrop then
                Library:Notify('Select a crop first!')
                Toggles.TpMyCropsToggle:SetValue(false)
                return
            end
            startFarm()
        else
            if not anyTpActive() then stopFarm() end
        end
    end
})

-- Fields Tab
local FieldsLeft = Tabs.Fields:AddLeftGroupbox('Fields TP - PRIORITY 3')

local FieldDrop = FieldsLeft:AddDropdown('FieldDropdown', {
    Values = getSortedValues(fieldNameCounts),
    Default = 1,
    Multi = false,
    Text = 'Select Field',
    Callback = function(v) selectedField = v end
})
if #FieldDrop.Values > 0 then selectedField = FieldDrop.Values[1] end

FieldsLeft:AddToggle('TpFieldsToggle', {
    Text = 'Fields TP - GOD SPEED (+3 Height)',
    Default = false,
    Callback = function(v)
        if v then
            if not selectedField then
                Library:Notify('Select a field first!')
                Toggles.TpFieldsToggle:SetValue(false)
                return
            end
            startFarm()
        else
            if not anyTpActive() then stopFarm() end
        end
    end
})

-- Auto Sell & Harvest (Main Tab Bottom)
LeftMain:AddSlider('AutoSellDelaySlider', {
    Text = 'Auto Sell Delay (s)',
    Default = 3,
    Min = 0.1,
    Max = 10,
    Rounding = 1,
    Callback = function(v) autoSellDelay = v end
})

LeftMain:AddToggle('AutoSellToggle', {
    Text = 'Auto Sell',
    Default = false,
    Callback = function(v)
        if v then
            task.spawn(function()
                local Event = ReplicatedStorage.Remotes:FindFirstChild("Purchase2")
                if not Event then Library:Notify('Purchase2 remote missing!') return end
                while Toggles.AutoSellToggle.Value do
                    pcall(function() Event:FireServer("fgtiuyw4eror4tuyfd%HHHHHHHhddset678%iftes7%7w4ftr76st76fs") end)
                    task.wait(autoSellDelay)
                end
            end)
        end
    end
})

LeftMain:AddToggle('SpamToggle', {
    Text = 'Harvest Swing - GOD SPEED',
    Default = false,
    Callback = function(v)
        local event = ReplicatedStorage:FindFirstChild("HarvestSwing")
        if not event then
            Library:Notify('HarvestSwing remote missing!')
            Toggles.SpamToggle:SetValue(false)
            return
        end
        local conn
        if v then
            conn = RunService.Stepped:Connect(function()
                if Toggles.SpamToggle.Value then
                    pcall(function() event:FireServer() end)
                end
            end)
        else
            if conn then conn:Disconnect() end
        end
    end
})

-- Upgrades Tab
local UpgradesLeft = Tabs.Upgrades:AddLeftGroupbox('Pumpkin Upgrades')

UpgradesLeft:AddSlider('UpgradeDelaySlider', {
    Text = 'Upgrade Delay (s)',
    Default = 1,
    Min = 0.1,
    Max = 5,
    Rounding = 1,
    Callback = function(v) upgradeDelay = v end
})

UpgradesLeft:AddToggle('PassiveSkullsToggle', {
    Text = 'Passive Skulls Upgrade',
    Default = false,
    Callback = function(v)
        if v then
            task.spawn(function()
                local Event = ReplicatedStorage.Remotes:FindFirstChild("Upgrade")
                if not Event then Library:Notify('Upgrade remote missing!') return end
                while Toggles.PassiveSkullsToggle.Value do
                    pcall(function() Event:FireServer("PassiveSkulls", "Pumpkin") end)
                    task.wait(upgradeDelay)
                end
            end)
        end
    end
})

UpgradesLeft:AddToggle('PumpkinUpgradeToggle', {
    Text = 'Pumpkin Upgrade',
    Default = false,
    Callback = function(v)
        if v then
            task.spawn(function()
                local Event = ReplicatedStorage.Remotes:FindFirstChild("Upgrade")
                if not Event then Library:Notify('Upgrade remote missing!') return end
                while Toggles.PumpkinUpgradeToggle.Value do
                    pcall(function() Event:FireServer("PumkinUpgrade", "Pumpkin") end)
                    task.wait(upgradeDelay)
                end
            end)
        end
    end
})

UpgradesLeft:AddToggle('PumpkinUpgrade2Toggle', {
    Text = 'Pumpkin Upgrade 2 (Skull)',
    Default = false,
    Callback = function(v)
        if v then
            task.spawn(function()
                local Event = ReplicatedStorage.Remotes:FindFirstChild("Upgrade")
                if not Event then Library:Notify('Upgrade remote missing!') return end
                while Toggles.PumpkinUpgrade2Toggle.Value do
                    pcall(function() Event:FireServer("PumkinUpgrade2", "Skull") end)
                    task.wait(upgradeDelay)
                end
            end)
        end
    end
})

UpgradesLeft:AddButton('Fire All Upgrades Once', function()
    local Event = ReplicatedStorage.Remotes:FindFirstChild("Upgrade")
    if not Event then Library:Notify('Upgrade remote missing!') return end
    pcall(function() Event:FireServer("PassiveSkulls", "Pumpkin") end)
    pcall(function() Event:FireServer("PumkinUpgrade", "Pumpkin") end)
    pcall(function() Event:FireServer("PumkinUpgrade2", "Skull") end)
    Library:Notify('All upgrades fired once!')
end)

-- Dropdown auto-refresh (every 1s, only set if changed)
task.spawn(function()
    while not Library.Unloaded do
        task.wait(1)
        local tokenVals = getSortedValues(tokenNameCounts)
        if #tokenVals > 0 then
            Options.TokenDropdown:SetValues(tokenVals)
            if not selectedToken or not table.find(tokenVals, selectedToken) then
                selectedToken = tokenVals[1]
                Options.TokenDropdown:SetValue(selectedToken)
            end
        end
    end
end)

task.spawn(function()
    while not Library.Unloaded do
        task.wait(1)
        local cropVals = getSortedValues(myCropNameCounts)
        if #cropVals > 0 then
            Options.MyCropDropdown:SetValues(cropVals)
            if not selectedMyCrop or not table.find(cropVals, selectedMyCrop) then
                selectedMyCrop = cropVals[1]
                Options.MyCropDropdown:SetValue(selectedMyCrop)
            end
        end
    end
end)

task.spawn(function()
    while not Library.Unloaded do
        task.wait(1)
        local fieldVals = getSortedValues(fieldNameCounts)
        if #fieldVals > 0 then
            Options.FieldDropdown:SetValues(fieldVals)
            if not selectedField or not table.find(fieldVals, selectedField) then
                selectedField = fieldVals[1]
                Options.FieldDropdown:SetValue(selectedField)
            end
        end
    end
end)

local MenuGroup = Tabs['UI Settings']:AddLeftGroupbox('Menu')

MenuGroup:AddButton('Unload', function() Library:Unload() end)

MenuGroup:AddLabel('Menu bind'):AddKeyPicker('MenuKeybind', { Default = 'End', NoUI = true, Text = 'Menu keybind' })

Library.ToggleKeybind = Options.MenuKeybind -- Custom keybind for the menu

MenuGroup:AddToggle('CustomCursorToggle', {
    Text = 'Enable Custom Cursor',
    Default = true,
    Callback = function(Value)
     
        Library.CursorEnabled = Value
        print('[cb] Custom Cursor toggled:', Value)
    end
})

Library:OnUnload(function()
    print('Unloaded!')
    Library.Unloaded = true
end)

Library:OnUnload(function()
    print('901 FarkÄ±yla')
    stopFarm()
    if connTokenAdd then connTokenAdd:Disconnect() end
    if connTokenRem then connTokenRem:Disconnect() end
    if connCropAdd then connCropAdd:Disconnect() end
    if connCropRem then connCropRem:Disconnect() end
    if connFieldAdd then connFieldAdd:Disconnect() end
    if connFieldRem then connFieldRem:Disconnect() end
    Library.Unloaded = true
end)
